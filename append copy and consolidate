def _append_rag_to_consolidated(self, consolidated_file: str):
    """
    Append RAG report data to consolidated file (Sheet2+)
    FIX: Properly handle existing sheets and append without recreating
    """
    try:
        # Find latest RAG report in temp_path
        rag_files = glob.glob(f"{self.temp_path}/RAG_Pattern_Analysis_*.xlsx")
        
        if not rag_files:
            logger.info("No RAG report found - skipping RAG consolidation")
            return
        
        # Get most recent RAG file
        latest_rag = max(rag_files, key=os.path.getctime)
        logger.info(f"Found RAG report: {os.path.basename(latest_rag)}")
        
        # Extract timestamp from filename
        rag_filename = os.path.basename(latest_rag)
        timestamp = rag_filename.replace("RAG_Pattern_Analysis_", "").replace(".xlsx", "")
        
        # RAG sheet names
        rag_sheets = [
            'Config Patterns',
            'Matched Patterns',
            'Unseen Patterns',
            'Suggestions',
            'Summary'
        ]
        
        # Load consolidated file (NOT read-only)
        consolidated_wb = load_workbook(consolidated_file)
        
        # Load RAG file (read-only is OK here)
        rag_wb = load_workbook(latest_rag, read_only=True)
        
        sheets_processed = 0
        sheets_skipped = 0
        
        try:
            for sheet_name in rag_sheets:
                if sheet_name not in rag_wb.sheetnames:
                    logger.debug(f"  Sheet '{sheet_name}' not in RAG - skipping")
                    sheets_skipped += 1
                    continue
                
                rag_sheet = rag_wb[sheet_name]
                
                # ===== FIX 1: Check if sheet already exists =====
                if sheet_name in consolidated_wb.sheetnames:
                    consolidated_sheet = consolidated_wb[sheet_name]
                    logger.info(f"  {sheet_name}: Sheet exists (appending)")
                else:
                    # Create sheet if doesn't exist
                    consolidated_sheet = consolidated_wb.create_sheet(sheet_name)
                    logger.info(f"  {sheet_name}: Sheet created (new)")
                
                # Read data from RAG sheet
                data = []
                headers = []
                
                for idx, row in enumerate(rag_sheet.iter_rows(values_only=True)):
                    if idx == 0:
                        headers = list(row)
                    else:
                        if any(cell is not None and str(cell).strip() for cell in row):
                            data.append(list(row))
                
                # Skip if no data
                if not data:
                    logger.info(f"    → No data - SKIPPED")
                    sheets_skipped += 1
                    continue
                
                # ===== FIX 2: Check if sheet has headers =====
                current_max_row = consolidated_sheet.max_row
                
                # If sheet is empty (only default empty row), write headers
                if current_max_row == 1:
                    # Check if row 1 has any data
                    has_header = False
                    for cell in consolidated_sheet[1]:
                        if cell.value is not None:
                            has_header = True
                            break
                    
                    if not has_header:
                        # Write headers
                        for col_idx, header in enumerate(headers, 1):
                            consolidated_sheet.cell(row=1, column=col_idx, value=header)
                        start_row = 2
                        logger.info(f"    → Headers written to row 1")
                    else:
                        # Headers already exist
                        start_row = 2
                else:
                    # Sheet has data, append after last row
                    start_row = current_max_row + 1
                
                # ===== FIX 3: Create dataframe and append =====
                df = pd.DataFrame(data, columns=headers)
                
                # Add metadata
                if 'Source File' not in df.columns:
                    df['Source File'] = rag_filename
                if 'Timestamp' not in df.columns:
                    df['Timestamp'] = timestamp
                
                # Append rows
                for row_idx, row_data in enumerate(dataframe_to_rows(df, index=False, header=False)):
                    for col_idx, value in enumerate(row_data, 1):
                        consolidated_sheet.cell(row=start_row + row_idx, column=col_idx, value=value)
                
                logger.info(f"    ✓ Appended {len(data)} rows (rows {start_row}-{start_row + len(data) - 1})")
                sheets_processed += 1
            
            # ===== FIX 4: Save PROPERLY =====
            try:
                consolidated_wb.save(consolidated_file)
                logger.info(f"✓ File saved successfully: {consolidated_file}")
            except Exception as save_error:
                logger.error(f"Save error: {save_error}")
                # Try to close and reopen
                consolidated_wb.close()
                consolidated_wb = load_workbook(consolidated_file)
                consolidated_wb.save(consolidated_file)
                logger.info(f"✓ File saved (retry successful)")
            
            logger.info(f"✓ RAG consolidation: {sheets_processed} processed, {sheets_skipped} skipped")
        
        finally:
            try:
                consolidated_wb.close()
                rag_wb.close()
            except:
                pass
    
    except Exception as e:
        logger.error(f"RAG consolidation error: {e}", exc_info=True)
        raise
