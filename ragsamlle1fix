"""
Complete Offline RAG with Excel Report Generation
Uses individual label patterns and saves comprehensive RAG report
"""

import os
import re
import json
import logging
from typing import Dict, List, Set
from collections import defaultdict
from datetime import datetime
import pandas as pd

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


# ============================================================================
# COMPLETE INTEGRATION WITH EXCEL REPORT
# ============================================================================

class CompleteOfflineRAGExtractor:
    """Complete RAG extractor with Excel report generation"""
    
    def __init__(self, pattern_manager, tracker):
        self.pattern_manager = pattern_manager
        self.tracker = tracker
        
        # Initialize components
        from offline_rag import OfflinePatternKnowledgeBase, OfflinePatternSuggestionEngine
        
        self.knowledge_base = OfflinePatternKnowledgeBase(pattern_manager.config_file)
        self.unseen_detector = SmartUnseenPatternDetector(pattern_manager, self.knowledge_base)
        self.suggestion_engine = OfflinePatternSuggestionEngine(self.knowledge_base)
        
        self.extraction_log = []
    
    def extract_entity(self, text: str, entity_name: str) -> Dict:
        """Extract entity with enhanced unseen detection"""
        patterns = self.pattern_manager.get_patterns_for_entity(entity_name)
        
        result = {
            'value': None,
            'pattern_id': None,
            'entity_name': entity_name,
            'is_unseen': False
        }
        
        # Try existing patterns
        for pattern_entry in patterns:
            pattern_id = pattern_entry['pattern_id']
            pattern_regex = pattern_entry['pattern']
            
            self.tracker.record_attempt(pattern_id)
            
            try:
                match = re.search(pattern_regex, text, re.IGNORECASE | re.MULTILINE | re.DOTALL)
                if match:
                    # Try named groups first
                    group_dict = match.groupdict()
                    extracted_value = None
                    
                    if group_dict:
                        for group_name, group_value in group_dict.items():
                            if group_value:
                                extracted_value = group_value
                                break
                    else:
                        extracted_value = match.group(1) if match.lastindex and match.lastindex >= 1 else match.group(0)
                    
                    if extracted_value:
                        self.tracker.record_match(pattern_id, extracted_value.strip())
                        result['value'] = extracted_value.strip()
                        result['pattern_id'] = pattern_id
                        break
            except:
                pass
        
        # Detect unseen patterns
        if not result['value']:
            result['is_unseen'] = self.unseen_detector.detect_unseen(text, entity_name, result)
        
        return result
    
    def extract_all_entities(self, text: str) -> Dict[str, Dict]:
        """Extract all entities"""
        entity_names = self.pattern_manager.get_all_entity_names()
        return {name: self.extract_entity(text, name) for name in entity_names}
    
    def save_comprehensive_rag_report(self, output_path: str):
        """
        Save comprehensive RAG report with multiple sheets:
        1. Label Pattern Library
        2. Unseen Patterns Overview
        3. Candidates by Label
        4. Pattern Suggestions
        5. Extraction Summary
        """
        logger.info(f"Generating comprehensive RAG report: {output_path}")
        
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            
            # Sheet 1: Label Pattern Library
            self._save_label_library_sheet(writer)
            
            # Sheet 2: Unseen Patterns Overview
            self._save_unseen_overview_sheet(writer)
            
            # Sheet 3: Candidates by Label (Detailed)
            self._save_candidates_by_label_sheet(writer)
            
            # Sheet 4: Pattern Suggestions
            self._save_pattern_suggestions_sheet(writer)
            
            # Sheet 5: Extraction Summary
            self._save_extraction_summary_sheet(writer)
        
        logger.info(f"✓ RAG report saved: {output_path}")
    
    def _save_label_library_sheet(self, writer):
        """Sheet 1: Label Pattern Library"""
        library_data = []
        
        for label, pattern_list in self.unseen_detector.label_pattern_library.items():
            for pattern_info in pattern_list:
                library_data.append({
                    'Label': label,
                    'Pattern': pattern_info['pattern'][:100],  # Truncate for readability
                    'Source Pattern ID': pattern_info['source_pattern_id'],
                    'Source Entity': pattern_info['source_entity'],
                    'Full Pattern': pattern_info['pattern']
                })
        
        if library_
            df = pd.DataFrame(library_data)
            df.to_excel(writer, sheet_name='Label Pattern Library', index=False)
            logger.info(f"  ✓ Label Pattern Library: {len(library_data)} patterns")
    
    def _save_unseen_overview_sheet(self, writer):
        """Sheet 2: Unseen Patterns Overview"""
        unseen_summary = self.unseen_detector.get_unseen_summary()
        overview_data = []
        
        for entity_name, data in unseen_summary.items():
            labels_found = ', '.join(data.get('by_label', {}).keys())
            
            # Get examples from all labels
            all_examples = []
            for label_data in data.get('by_label', {}).values():
                all_examples.extend(label_data['examples'][:3])
            
            overview_data.append({
                'Entity': entity_name,
                'Total Candidates': data['total_count'],
                'Labels Found': labels_found,
                'Sample Values': ', '.join(all_examples[:5])
            })
        
        if overview_
            df = pd.DataFrame(overview_data)
            df.to_excel(writer, sheet_name='Unseen Overview', index=False)
            logger.info(f"  ✓ Unseen Overview: {len(overview_data)} entities")
    
    def _save_candidates_by_label_sheet(self, writer):
        """Sheet 3: Detailed Candidates by Label"""
        unseen_summary = self.unseen_detector.get_unseen_summary()
        detailed_data = []
        
        for entity_name, data in unseen_summary.items():
            for label, label_data in data.get('by_label', {}).items():
                for example in label_data['examples']:
                    patterns_used = label_data.get('patterns_used', [])
                    pattern_sample = patterns_used[0][:80] if patterns_used else 'N/A'
                    
                    detailed_data.append({
                        'Entity': entity_name,
                        'Label': label,
                        'Candidate Value': example,
                        'Total Count': label_data['count'],
                        'Patterns Used Count': label_data['pattern_count'],
                        'Sample Pattern': pattern_sample
                    })
        
        if detailed_
            df = pd.DataFrame(detailed_data)
            df.to_excel(writer, sheet_name='Candidates by Label', index=False)
            logger.info(f"  ✓ Candidates by Label: {len(detailed_data)} candidates")
    
    def _save_pattern_suggestions_sheet(self, writer):
        """Sheet 4: RAG Pattern Suggestions"""
        unseen_summary = self.unseen_detector.get_unseen_summary()
        suggestions_data = []
        
        for entity_name, data in unseen_summary.items():
            # Get examples for suggestions
            all_examples = []
            for label_data in data.get('by_label', {}).values():
                all_examples.extend(label_data['examples'][:5])
            
            if all_examples:
                # Generate suggestions
                suggestions = self.suggestion_engine.suggest_patterns(entity_name, all_examples)
                
                for sug in suggestions:
                    suggestions_data.append({
                        'Entity': entity_name,
                        'Suggested Pattern': sug['suggested_pattern'],
                        'Method': sug['method'],
                        'Similarity Score': sug['similarity_score'],
                        'Based On': sug['based_on_pattern_id'],
                        'Reasoning': sug['reasoning'],
                        'Test Examples': ', '.join(sug['test_examples'][:3])
                    })
        
        if suggestions_
            df = pd.DataFrame(suggestions_data)
            df.to_excel(writer, sheet_name='Pattern Suggestions', index=False)
            logger.info(f"  ✓ Pattern Suggestions: {len(suggestions_data)} suggestions")
    
    def _save_extraction_summary_sheet(self, writer):
        """Sheet 5: Overall Extraction Summary"""
        unseen_summary = self.unseen_detector.get_unseen_summary()
        
        # Calculate statistics
        total_entities = len(unseen_summary)
        total_candidates = sum(data['total_count'] for data in unseen_summary.values())
        
        # Labels with most candidates
        label_counts = defaultdict(int)
        for data in unseen_summary.values():
            for label, label_data in data.get('by_label', {}).items():
                label_counts[label] += label_data['count']
        
        top_labels = sorted(label_counts.items(), key=lambda x: x[1], reverse=True)[:10]
        
        summary_data = [{
            'Metric': 'Total Entities with Unseen Patterns',
            'Value': str(total_entities)
        }, {
            'Metric': 'Total Candidates Extracted',
            'Value': str(total_candidates)
        }, {
            'Metric': 'Unique Labels Found',
            'Value': str(len(label_counts))
        }, {
            'Metric': 'Label Patterns in Library',
            'Value': str(len(self.unseen_detector.label_pattern_library))
        }]
        
        # Add top labels
        for i, (label, count) in enumerate(top_labels, 1):
            summary_data.append({
                'Metric': f'Top Label #{i}',
                'Value': f'{label} ({count} candidates)'
            })
        
        df = pd.DataFrame(summary_data)
        df.to_excel(writer, sheet_name='Extraction Summary', index=False)
        logger.info(f"  ✓ Extraction Summary: {len(summary_data)} metrics")


# ============================================================================
# DEMO WITH EXCEL REPORT
# ============================================================================

def demo_with_excel_report():
    """Complete demo that generates Excel report"""
    from pattern_tracking import PatternManager, PatternUsageTracker
    
    print("="*80)
    print("OFFLINE RAG POC - WITH COMPREHENSIVE EXCEL REPORT")
    print("="*80)
    
    # Initialize
    pattern_manager = PatternManager("Pattern_Config.json")
    tracker = PatternUsageTracker()
    
    print("\n[1/4] Initializing RAG components...")
    extractor = CompleteOfflineRAGExtractor(pattern_manager, tracker)
    
    print(f"[2/4] Loaded {len(extractor.unseen_detector.label_pattern_library)} label patterns")
    
    # Sample test data
    sample_emails = [
        {
            'subject': 'Trade Confirmation',
            'body': '''
            Trade Details:
            Trade ID: 12345678A
            Currency: USD
            Secondary Currency: EUR
            Notional Amount: $100,000,000
            Status: Confirmed
            Product: Interest Rate Swap
            Sub-Product: Fixed-Float-Swap
            MarketwireID: MW2025110001
            Business Date: 11/10/2025
            '''
        },
        {
            'subject': 'New Format Deal',
            'body': '''
            Deal Reference: XYZ-2025-11-001
            CCY1: GBP
            CCY2: JPY
            State: PENDING
            TradeAmount: 50000000
            ProductType: FX_SWAP
            '''
        },
        {
            'subject': 'Alternative Structure',
            'body': '''
            Package ID: PKG_2025_Q4_001
            Base Currency: CHF
            Quote Currency: AUD
            NotionalValue: 25MM
            TradeStatus: EXECUTED
            '''
        }
    ]
    
    print(f"[3/4] Processing {len(sample_emails)} sample emails...")
    
    # Process emails
    for i, email in enumerate(sample_emails, 1):
        text = f"{email['subject']}\n{email['body']}"
        results = extractor.extract_all_entities(text)
        
        found_count = sum(1 for r in results.values() if r['value'])
        unseen_count = sum(1 for r in results.values() if r['is_unseen'])
        
        print(f"  Email {i}: {found_count} found, {unseen_count} unseen")
    
    # Generate report
    print("\n[4/4] Generating comprehensive RAG report...")
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    report_path = f"RAG_Pattern_Analysis_{timestamp}.xlsx"
    
    extractor.save_comprehensive_rag_report(report_path)
    
    print("\n" + "="*80)
    print("✓ COMPLETE!")
    print("="*80)
    print(f"\nExcel Report: {report_path}")
    print("\nReport contains 5 sheets:")
    print("  1. Label Pattern Library - All extracted label patterns")
    print("  2. Unseen Overview - High-level summary")
    print("  3. Candidates by Label - Detailed candidate data")
    print("  4. Pattern Suggestions - RAG-based pattern recommendations")
    print("  5. Extraction Summary - Statistics and metrics")
    print("\n" + "="*80)
    
    # Print quick summary
    unseen_summary = extractor.unseen_detector.get_unseen_summary()
    if unseen_summary:
        print("\nQuick Summary:")
        for entity, data in unseen_summary.items():
            print(f"  {entity}: {data['total_count']} candidates across {len(data['by_label'])} labels")


if __name__ == "__main__":
    demo_with_excel_report()
