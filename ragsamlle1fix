"""
Complete Offline RAG with Simplified Pattern Detection
Only SmartUnseenPatternDetector changed - uses complete config patterns
Keeps comprehensive save_comprehensive_rag_report as-is
"""

import os
import re
import json
import logging
from typing import Dict, List
from collections import defaultdict
from datetime import datetime
import pandas as pd

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


# ============================================================================
# UPDATED: SmartUnseenPatternDetector - Uses Complete Config Patterns
# ============================================================================

class SmartUnseenPatternDetector:
    """
    Updated detector that:
    1. Uses complete patterns from config with IDs (no label decomposition)
    2. Tries all config patterns to extract candidates
    3. Returns structured data for comprehensive report
    """
    
    def __init__(self, pattern_manager, knowledge_base):
        self.pattern_manager = pattern_manager
        self.knowledge_base = knowledge_base
        self.unseen_texts = defaultdict(list)
        
        # Load all patterns with IDs from config
        self.all_config_patterns = self._load_all_patterns_with_ids()
        
        # Build label pattern library for report compatibility
        self.label_pattern_library = self._build_label_library_for_report()
    
    def _load_all_patterns_with_ids(self) -> List[Dict]:
        """Load all patterns from config with their IDs"""
        all_patterns = []
        
        for entity_name in self.pattern_manager.get_all_entity_names():
            patterns = self.pattern_manager.get_patterns_for_entity(entity_name)
            all_patterns.extend(patterns)
        
        logger.info(f"Loaded {len(all_patterns)} patterns from config")
        return all_patterns
    
    def _build_label_library_for_report(self) -> Dict[str, List[Dict]]:
        """Build label library for report (shows which patterns exist)"""
        library = defaultdict(list)
        
        for pattern_info in self.all_config_patterns:
            pattern_id = pattern_info.get('pattern_id', 'UNKNOWN')
            entity_name = pattern_info.get('entity_name', 'Unknown')
            pattern_str = pattern_info.get('pattern', '')
            
            # Add to library indexed by pattern ID
            library[pattern_id].append({
                'label': pattern_id,
                'pattern': pattern_str,
                'source_pattern_id': pattern_id,
                'source_entity': entity_name,
                'original_composite': pattern_str
            })
        
        logger.info(f"Built label library with {len(library)} pattern IDs")
        return library
    
    def detect_unseen(self, text: str, entity_name: str, extracted_result: Dict) -> bool:
        """Detect unseen patterns by trying all config patterns"""
        if not extracted_result.get('value'):
            candidates = self._extract_candidates_with_config_patterns(text, entity_name)
            
            if candidates:
                self.unseen_texts[entity_name].extend(candidates)
                return True
        
        return False
    
    def _extract_candidates_with_config_patterns(self, text: str, entity_name: str) -> List[Dict]:
        """
        Extract candidates using ALL patterns from config
        This is the core RAG approach: use existing patterns to find unseen data
        """
        candidates = []
        seen_values = set()
        
        logger.info(f"Trying {len(self.all_config_patterns)} config patterns...")
        
        # Try each pattern from config
        for pattern_info in self.all_config_patterns:
            pattern_id = pattern_info.get('pattern_id', 'UNKNOWN')
            pattern_str = pattern_info.get('pattern', '')
            source_entity = pattern_info.get('entity_name', 'Unknown')
            
            if not pattern_str:
                continue
            
            try:
                # Try to match the pattern
                matches = re.finditer(pattern_str, text, re.IGNORECASE | re.MULTILINE | re.DOTALL)
                
                for match in matches:
                    # Extract values from match
                    extracted_values = []
                    
                    # Try named groups first
                    group_dict = match.groupdict()
                    if group_dict:
                        for group_name, group_value in group_dict.items():
                            if group_value and group_value.strip():
                                extracted_values.append((group_name, group_value.strip()))
                    
                    # Try group 1
                    elif match.lastindex and match.lastindex >= 1:
                        value = match.group(1).strip()
                        if value:
                            extracted_values.append(('group_1', value))
                    
                    # Full match fallback
                    else:
                        value = match.group(0).strip()
                        if value:
                            extracted_values.append(('full_match', value))
                    
                    # Create candidate entries
                    for label, value in extracted_values:
                        if value not in seen_values:
                            candidates.append({
                                'value': value,
                                'label': label,
                                'pattern_used': pattern_str[:100],
                                'source_pattern_id': pattern_id,
                                'entity_name': entity_name,
                                'extraction_method': 'config_pattern_match',
                                'source_entity': source_entity
                            })
                            seen_values.add(value)
                            logger.debug(f"  ✓ Pattern {pattern_id}: {value[:50]}")
            
            except re.error as e:
                logger.debug(f"Pattern {pattern_id} regex error: {e}")
            except Exception as e:
                logger.debug(f"Pattern {pattern_id} error: {e}")
        
        logger.info(f"Extracted {len(candidates)} candidates using config patterns")
        return candidates
    
    def get_unseen_summary(self) -> Dict:
        """
        Get summary compatible with comprehensive report
        Returns data in format expected by report sheets
        """
        summary = {}
        
        for entity_name, candidate_list in self.unseen_texts.items():
            # Group by label (extracted field name)
            by_label = defaultdict(lambda: {'values': [], 'patterns_used': set()})
            
            for candidate in candidate_list:
                if isinstance(candidate, dict):
                    label = candidate.get('label', 'UNKNOWN')
                    value = candidate.get('value', str(candidate))
                    pattern_used = candidate.get('pattern_used', 'N/A')
                    
                    by_label[label]['values'].append(value)
                    by_label[label]['patterns_used'].add(pattern_used)
            
            # Create summary in expected format
            summary[entity_name] = {
                'total_count': len(candidate_list),
                'by_label': {
                    label: {
                        'count': len(data['values']),
                        'examples': list(set(data['values']))[:10],
                        'pattern_count': len(data['patterns_used']),
                        'patterns_used': list(data['patterns_used'])[:3]
                    }
                    for label, data in by_label.items()
                }
            }
        
        return summary


# ============================================================================
# COMPLETE EXTRACTOR (Unchanged - Uses Comprehensive Report)
# ============================================================================

class CompleteOfflineRAGExtractor:
    """Complete RAG extractor with comprehensive Excel report"""
    
    def __init__(self, pattern_manager, tracker):
        self.pattern_manager = pattern_manager
        self.tracker = tracker
        
        # Initialize components
        from offline_rag import OfflinePatternKnowledgeBase, OfflinePatternSuggestionEngine
        
        self.knowledge_base = OfflinePatternKnowledgeBase(pattern_manager.config_file)
        self.unseen_detector = SmartUnseenPatternDetector(pattern_manager, self.knowledge_base)
        self.suggestion_engine = OfflinePatternSuggestionEngine(self.knowledge_base)
        
        self.extraction_log = []
    
    def extract_entity(self, text: str, entity_name: str) -> Dict:
        """Extract entity with unseen detection"""
        patterns = self.pattern_manager.get_patterns_for_entity(entity_name)
        
        result = {
            'value': None,
            'pattern_id': None,
            'entity_name': entity_name,
            'is_unseen': False
        }
        
        # Try existing patterns
        for pattern_entry in patterns:
            pattern_id = pattern_entry['pattern_id']
            pattern_regex = pattern_entry['pattern']
            
            self.tracker.record_attempt(pattern_id)
            
            try:
                match = re.search(pattern_regex, text, re.IGNORECASE | re.MULTILINE | re.DOTALL)
                if match:
                    group_dict = match.groupdict()
                    extracted_value = None
                    
                    if group_dict:
                        for group_name, group_value in group_dict.items():
                            if group_value:
                                extracted_value = group_value
                                break
                    else:
                        extracted_value = match.group(1) if match.lastindex and match.lastindex >= 1 else match.group(0)
                    
                    if extracted_value:
                        self.tracker.record_match(pattern_id, extracted_value.strip())
                        result['value'] = extracted_value.strip()
                        result['pattern_id'] = pattern_id
                        break
            except:
                pass
        
        # Detect unseen patterns
        if not result['value']:
            result['is_unseen'] = self.unseen_detector.detect_unseen(text, entity_name, result)
        
        return result
    
    def extract_all_entities(self, text: str) -> Dict[str, Dict]:
        """Extract all entities"""
        entity_names = self.pattern_manager.get_all_entity_names()
        return {name: self.extract_entity(text, name) for name in entity_names}
    
    def save_comprehensive_rag_report(self, output_path: str):
        """
        UNCHANGED - Save comprehensive RAG report with 5 sheets
        """
        logger.info(f"Generating comprehensive RAG report: {output_path}")
        
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            
            # Sheet 1: Label Pattern Library (shows all config patterns)
            self._save_label_library_sheet(writer)
            
            # Sheet 2: Unseen Patterns Overview
            self._save_unseen_overview_sheet(writer)
            
            # Sheet 3: Candidates by Label
            self._save_candidates_by_label_sheet(writer)
            
            # Sheet 4: Pattern Suggestions
            self._save_pattern_suggestions_sheet(writer)
            
            # Sheet 5: Extraction Summary
            self._save_extraction_summary_sheet(writer)
        
        logger.info(f"✓ RAG report saved: {output_path}")
    
    def _save_label_library_sheet(self, writer):
        """Sheet 1: Config Patterns Library"""
        library_data = []
        
        for pattern_info in self.unseen_detector.all_config_patterns:
            library_data.append({
                'Pattern ID': pattern_info.get('pattern_id', 'N/A'),
                'Entity': pattern_info.get('entity_name', 'N/A'),
                'Pattern Preview': pattern_info.get('pattern', '')[:100],
                'Full Pattern': pattern_info.get('pattern', '')
            })
        
        if library_
            df = pd.DataFrame(library_data)
            df.to_excel(writer, sheet_name='Config Patterns', index=False)
            logger.info(f"  ✓ Config Patterns: {len(library_data)} patterns")
    
    def _save_unseen_overview_sheet(self, writer):
        """Sheet 2: Unseen Patterns Overview"""
        unseen_summary = self.unseen_detector.get_unseen_summary()
        overview_data = []
        
        for entity_name, data in unseen_summary.items():
            labels_found = ', '.join(data.get('by_label', {}).keys())
            
            all_examples = []
            for label_data in data.get('by_label', {}).values():
                all_examples.extend(label_data['examples'][:3])
            
            overview_data.append({
                'Entity': entity_name,
                'Total Candidates': data['total_count'],
                'Fields Found': labels_found,
                'Sample Values': ', '.join(all_examples[:5])
            })
        
        if overview_
            df = pd.DataFrame(overview_data)
            df.to_excel(writer, sheet_name='Unseen Overview', index=False)
            logger.info(f"  ✓ Unseen Overview: {len(overview_data)} entities")
    
    def _save_candidates_by_label_sheet(self, writer):
        """Sheet 3: Detailed Candidates"""
        unseen_summary = self.unseen_detector.get_unseen_summary()
        detailed_data = []
        
        for entity_name, data in unseen_summary.items():
            for label, label_data in data.get('by_label', {}).items():
                for example in label_data['examples']:
                    patterns_used = label_data.get('patterns_used', [])
                    pattern_sample = patterns_used[0][:80] if patterns_used else 'N/A'
                    
                    detailed_data.append({
                        'Entity': entity_name,
                        'Field': label,
                        'Candidate Value': example,
                        'Total Count': label_data['count'],
                        'Patterns Used': label_data['pattern_count'],
                        'Sample Pattern': pattern_sample
                    })
        
        if detailed_
            df = pd.DataFrame(detailed_data)
            df.to_excel(writer, sheet_name='Candidates Detail', index=False)
            logger.info(f"  ✓ Candidates Detail: {len(detailed_data)} candidates")
    
    def _save_pattern_suggestions_sheet(self, writer):
        """Sheet 4: RAG Pattern Suggestions"""
        unseen_summary = self.unseen_detector.get_unseen_summary()
        suggestions_data = []
        
        for entity_name, data in unseen_summary.items():
            all_examples = []
            for label_data in data.get('by_label', {}).values():
                all_examples.extend(label_data['examples'][:5])
            
            if all_examples:
                suggestions = self.suggestion_engine.suggest_patterns(entity_name, all_examples)
                
                for sug in suggestions:
                    suggestions_data.append({
                        'Entity': entity_name,
                        'Suggested Pattern': sug['suggested_pattern'][:150],
                        'Method': sug['method'],
                        'Similarity Score': sug['similarity_score'],
                        'Based On': sug['based_on_pattern_id'],
                        'Reasoning': sug['reasoning'],
                        'Test Examples': ', '.join(sug['test_examples'][:3])
                    })
        
        if suggestions_
            df = pd.DataFrame(suggestions_data)
            df.to_excel(writer, sheet_name='RAG Suggestions', index=False)
            logger.info(f"  ✓ RAG Suggestions: {len(suggestions_data)} suggestions")
    
    def _save_extraction_summary_sheet(self, writer):
        """Sheet 5: Summary Statistics"""
        unseen_summary = self.unseen_detector.get_unseen_summary()
        
        total_entities = len(unseen_summary)
        total_candidates = sum(data['total_count'] for data in unseen_summary.values())
        
        label_counts = defaultdict(int)
        for data in unseen_summary.values():
            for label, label_data in data.get('by_label', {}).items():
                label_counts[label] += label_data['count']
        
        top_labels = sorted(label_counts.items(), key=lambda x: x[1], reverse=True)[:10]
        
        summary_data = [{
            'Metric': 'Total Entities with Unseen Patterns',
            'Value': str(total_entities)
        }, {
            'Metric': 'Total Candidates Extracted',
            'Value': str(total_candidates)
        }, {
            'Metric': 'Config Patterns Used',
            'Value': str(len(self.unseen_detector.all_config_patterns))
        }]
        
        for i, (label, count) in enumerate(top_labels, 1):
            summary_data.append({
                'Metric': f'Top Field #{i}',
                'Value': f'{label} ({count} candidates)'
            })
        
        df = pd.DataFrame(summary_data)
        df.to_excel(writer, sheet_name='Summary', index=False)
        logger.info(f"  ✓ Summary: {len(summary_data)} metrics")


# ============================================================================
# DEMO
# ============================================================================

def demo_complete_rag():
    """Demo with complete RAG and comprehensive report"""
    from pattern_tracking import PatternManager, PatternUsageTracker
    
    print("="*80)
    print("COMPLETE OFFLINE RAG - Using Config Patterns with Comprehensive Report")
    print("="*80)
    
    pattern_manager = PatternManager("Pattern_Config.json")
    tracker = PatternUsageTracker()
    
    print("\n[1/4] Initializing RAG...")
    extractor = CompleteOfflineRAGExtractor(pattern_manager, tracker)
    print(f"  ✓ Loaded {len(extractor.unseen_detector.all_config_patterns)} config patterns")
    
    # Sample data
    sample_emails = [
        {
            'subject': 'Trade Confirmation',
            'body': 'Trade ID: 12345678A\nCurrency: USD\nStatus: Confirmed'
        },
        {
            'subject': 'New Format',
            'body': 'Deal: XYZ-2025-11-001\nCCY: EUR\nState: PENDING'
        }
    ]
    
    print(f"\n[2/4] Processing {len(sample_emails)} emails...")
    for i, email in enumerate(sample_emails, 1):
        text = f"{email['subject']}\n{email['body']}"
        results = extractor.extract_all_entities(text)
        found = sum(1 for r in results.values() if r['value'])
        unseen = sum(1 for r in results.values() if r['is_unseen'])
        print(f"  Email {i}: {found} found, {unseen} unseen")
    
    print("\n[3/4] Generating comprehensive RAG report...")
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    report_path = f"Complete_RAG_Report_{timestamp}.xlsx"
    extractor.save_comprehensive_rag_report(report_path)
    
    print("\n[4/4] Done!")
    print("\n" + "="*80)
    print(f"Report: {report_path}")
    print("\n5 Sheets:")
    print("  1. Config Patterns - All patterns from config with IDs")
    print("  2. Unseen Overview - High-level summary")
    print("  3. Candidates Detail - All extracted candidates")
    print("  4. RAG Suggestions - Pattern recommendations")
    print("  5. Summary - Statistics")
    print("="*80)


if __name__ == "__main__":
    demo_complete_rag()
