import streamlit as st
import os
import datetime
import json
from pathlib import Path

class EmailEntityExtractor:
    def __init__(self):
        """Initialize Streamlit UI components and session state"""
        
        # Initialize session state variables if not exists
        if 'date_var' not in st.session_state:
            st.session_state.date_var = datetime.date.today().strftime("%Y-%m-%d")
        if 'folder_var' not in st.session_state:
            st.session_state.folder_var = ""
        if 'file_path_var' not in st.session_state:
            st.session_state.file_path_var = ""
        if 'trade_ids_var' not in st.session_state:
            st.session_state.trade_ids_var = ""
        if 'selected_columns' not in st.session_state:
            st.session_state.selected_columns = []
        if 'activity_keywords' not in st.session_state:
            st.session_state.activity_keywords = []
        if 'trade_status' not in st.session_state:
            st.session_state.trade_status = []
        if 'static_headers' not in st.session_state:
            st.session_state.static_headers = []
        if 'mailbox_folders' not in st.session_state:
            st.session_state.mailbox_folders = []
        if 'emails' not in st.session_state:
            st.session_state.emails = []
        if 'selected_email' not in st.session_state:
            st.session_state.selected_email = None
        if 'displayed_emails' not in st.session_state:
            st.session_state.displayed_emails = []
        if 'current_email_index' not in st.session_state:
            st.session_state.current_email_index = -1
        if 'entity_definitions' not in st.session_state:
            st.session_state.entity_definitions = None
        
        # App configuration
        st.set_page_config(
            page_title="Email Harvester Bot",
            layout="wide",
            initial_sidebar_state="expanded"
        )
        
        # Title
        st.title("ğŸ“§ Email Harvester Bot")
        
        # Load pattern config
        config_filename = os.path.join(os.getcwd(), 'Pattern_Config.json')
        
        # Initialize pattern manager and usage tracker
        self.pattern_manager = PatternManager(config_filename)
        self.usage_tracker = PatternUsageTracker()
        
        # Load config data
        if os.path.exists(config_filename):
            with open(config_filename, 'r') as f:
                config_data = json.load(f)
                if config_
                    st.success("âœ… Config Loaded Successfully")
                    st.session_state.entity_definitions = config_data
                else:
                    st.error("âŒ Config Load Failed")
        else:
            st.error("âŒ Config File Not Found Failed")
        
        # Hardcoded mailbox/folder configuration
        st.session_state.mailbox_folders = [
            # Add your mailbox folders here
        ]
        
        # Create layout
        self.create_ui()
    
    def create_ui(self):
        """Create the main Streamlit UI layout"""
        
        # Sidebar for inputs
        with st.sidebar:
            st.header("ğŸ“‹ Input Parameters")
            
            # Mailbox/Folder Selection
            st.subheader("Select Mailbox:")
            mailbox_options = ["Sent Items"] + list(st.session_state.mailbox_folders.keys())
            selected_mailbox = st.selectbox(
                "Mailbox",
                options=mailbox_options,
                key="mailbox_combo"
            )
            
            # Date Selection
            st.subheader("Select Date:")
            st.session_state.date_var = st.date_input(
                "Date",
                value=datetime.datetime.strptime(st.session_state.date_var, "%Y-%m-%d"),
                format="YYYY-MM-DD",
                key="date_picker"
            ).strftime("%Y-%m-%d")
            
            # Outlook Folder Selection
            st.subheader("Select Outlook Folder:")
            st.session_state.folder_var = st.text_input(
                "Folder Path",
                value=st.session_state.folder_var,
                key="folder_input"
            )
            
            # File Path for Input Trade_Id
            st.subheader("Browse for Input Trade_Id File:")
            uploaded_file = st.file_uploader(
                "Upload CSV/Excel File",
                type=['csv', 'xlsx', 'xls'],
                key="file_uploader"
            )
            if uploaded_file:
                st.session_state.file_path_var = uploaded_file.name
                st.info(f"ğŸ“ File: {uploaded_file.name}")
            
            # Trade ID Input
            st.subheader("Trade ID:")
            st.session_state.trade_ids_var = st.text_input(
                "Enter Trade IDs (comma-separated)",
                value=st.session_state.trade_ids_var,
                key="trade_id_input"
            )
            
            st.divider()
            
            # Action Buttons
            st.subheader("ğŸš€ Actions")
            
            col1, col2 = st.columns(2)
            with col1:
                if st.button("ğŸ“¥ Extract Emails", use_container_width=True):
                    self.extract_email_chain_from_outlook()
            
            with col2:
                if st.button("ğŸ“¤ Extract & Export", use_container_width=True):
                    self.extract_and_export()
            
            if st.button("ğŸ“Š Export Consolidated Results", use_container_width=True):
                self.export_consolidated_results()
            
            if st.button("ğŸ—‘ï¸ Clear Results", use_container_width=True):
                self.clear_results()
            
            # Progress bar
            st.session_state.progress = st.progress(0)
        
        # Main content area
        self.create_main_content()
    
    def create_main_content(self):
        """Create the main content area with tabs or sections"""
        
        # Email Chain Display
        st.header("ğŸ“§ Email Chain")
        
        # Create a dataframe view for emails (replacing Treeview)
        if st.session_state.emails:
            import pandas as pd
            
            email_df = pd.DataFrame(st.session_state.emails)
            
            # Display as interactive dataframe
            selected_rows = st.dataframe(
                email_df,
                use_container_width=True,
                hide_index=True,
                column_config={
                    "trade_id": st.column_config.TextColumn("Trade ID", width=120),
                    "Subject": st.column_config.TextColumn("Subject", width=200),
                    "From": st.column_config.TextColumn("From", width=120),
                    "To": st.column_config.TextColumn("To", width=120),
                    "Date": st.column_config.TextColumn("Date", width=120),
                    "Email Type": st.column_config.TextColumn("Email Type", width=80)
                }
            )
        else:
            st.info("No emails loaded. Use 'Extract Emails' to fetch data.")
        
        st.divider()
        
        # Email Content Display
        col1, col2 = st.columns([1, 1])
        
        with col1:
            st.subheader("ğŸ“„ Email Content")
            if st.session_state.selected_email:
                st.text_area(
                    "Content",
                    value=st.session_state.selected_email.get('body', ''),
                    height=400,
                    key="email_content_display"
                )
            else:
                st.info("Select an email from the table above")
        
        with col2:
            st.subheader("ğŸ” Extracted Entities")
            if st.session_state.selected_email and 'entities' in st.session_state.selected_email:
                st.json(st.session_state.selected_email['entities'])
            else:
                st.info("No entities extracted yet")
